<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
			crossorigin="anonymous"
		/>
		<link rel="stylesheet" href="css/style.css" />
		<title>Client</title>
	</head>
	<body class="d-flex align-items-center vh-100 justify-content-center">
		<div
			class="d-flex gap-4 border border-4 border-warning p-4"
			style="border-radius: 20px"
		>
			<div
				class="p-4 d-flex flex-column col justify-content-center align-items-center"
			>
				<h1>Loket 1</h1>
				<div
					class="rounded rounded-3 bg-warning d-flex justify-content-center align-items-center gap-4 flex-column p-4"
				>
					<h1>Nomor Antrian</h1>
					<p id="loket1" class="count">0</p>
				</div>
			</div>
			<div
				class="p-4 d-flex flex-column col justify-content-center align-items-center"
			>
				<h1>Loket 2</h1>
				<div
					class="rounded rounded-3 bg-warning d-flex justify-content-center align-items-center gap-4 flex-column p-4"
				>
					<h1>Nomor Antrian</h1>
					<p id="loket2" class="count">0</p>
				</div>
			</div>
		</div>
		<!-- Modal -->
		<div
			class="modal fade"
			id="antrianModal"
			tabindex="-1"
			aria-labelledby="antrianModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog modal-dialog-centered modal-xl">
				<div class="modal-content">
					<div class="modal-body">
						<div
							class="p-4 d-flex flex-column col justify-content-center align-items-center"
						>
							<h1 id="title-modal"></h1>
							<div
								class="rounded rounded-3 bg-warning d-flex justify-content-center align-items-center gap-4 flex-column p-4"
							>
								<h1>Nomor Antrian</h1>
								<p id="count-modal-loket" class="count">0</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
		crossorigin="anonymous"
	></script>
	<script>
		//connection ws
		const socket = new WebSocket('ws://localhost:8080');
		socket.addEventListener('open', (e) => {
			console.log('display connected to server ws');
		});

		const loket1 = document.getElementById('loket1');
		const loket2 = document.getElementById('loket2');
		let queue1 = Number(loket1.innerHTML);
		let queue2 = Number(loket2.innerHTML);
		const myModal = document.getElementById('antrianModal');
		const modal = new bootstrap.Modal(myModal);
		const titleModal = document.getElementById('title-modal');
		const countModal = document.getElementById('count-modal-loket');

		let activeLocket = 1;
		let modalCount = 0;
		let initTimeOut = undefined;

		const modalTimeout = () => {
			initTimeOut = setTimeout(() => {
				modal.hide();
			}, 8000);
		};

		const handleClearTimeOut = () => {
			if (initTimeOut) {
				clearTimeout(initTimeOut);
			}
		};
		// listen for message
		socket.addEventListener('message', (e) => {
			handleClearTimeOut();
			if (e.data == 'next1') {
				activeLocket = 1;
				queue1++;
				modalCount = queue1;
			} else if (e.data == 'prev1' && queue1 > 0) {
				activeLocket = 1;
				queue1--;
				modalCount = queue1;
			} else if (e.data == 'next2') {
				activeLocket = 2;
				queue2++;
				modalCount = queue2;
			} else if (e.data == 'prev2' && queue2 > 0) {
				activeLocket = 2;
				queue2--;
				modalCount = queue2;
			}
			//set modal content
			titleModal.innerHTML = `Loket ${activeLocket}`;
			countModal.innerHTML = modalCount;
			if (modalCount > 0) {
				modal.show();
				modalTimeout();
			} else {
				modal.hide();
			}
			loket1.innerHTML = queue1;
			loket2.innerHTML = queue2;
			socket.send(`{ "queue1" : ${queue1}, "queue2" : ${queue2} }`);
		});
	</script>
</html>
